{% extends "base.html" %}

{% block title %}Daftar Hasil{% endblock %}

{% block extra_css %}
<style>
    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .btn-danger {
        background: #d32f2f;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
    }

    .btn-danger:hover {
        background: #c62828;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .results-table th, .results-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .results-table th {
        background: #D2C1B6;
        color: white;
        font-weight: 600;
    }
    
    .results-table tr:hover {
        background: #f5f5f5;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
        background: white;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    .thumbnail {
        max-width: 100px;
        max-height: 100px;
        border-radius: 4px;
        cursor: pointer;
        transition: transform 0.3s;
    }

    .thumbnail:hover {
        transform: scale(1.1);
    }

    /* Flash Messages */
    .flash-messages {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
    }

    .alert {
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        font-weight: 500;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .close-btn {
        float: right;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: inherit;
        margin-left: 10px;
    }

    /* Confirmation dialog */
    .confirm-dialog {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }

    .confirm-dialog.show {
        display: flex;
    }

    .confirm-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .confirm-content h2 {
        margin-bottom: 15px;
        color: #333;
    }

    .confirm-content p {
        margin: 10px 0;
        color: #666;
    }

    .confirm-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }

    .filter-badge {
        display: inline-block;
        padding: 5px 10px;
        background: #D2C1B6;
        color: white;
        border-radius: 15px;
        font-size: 0.85em;
        font-weight: 500;
    }

    /* Modal for image preview */
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        justify-content: center;
        align-items: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 10px;
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 40px;
        color: white;
        font-size: 40px;
        cursor: pointer;
        background: none;
        border: none;
    }

    @media (max-width: 768px) {
        .header-section {
            flex-direction: column;
            align-items: stretch;
        }

        .thumbnail {
            max-width: 60px;
            max-height: 60px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
          {{ message }}
          <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="nav">
    <a href="{{ url_for('processing') }}">Kembali ke Pengolahan</a>
    <a href="{{ url_for('logout') }}">Logout</a>
</div>

<div class="header-section">
    <h1>Daftar Citra yang Telah Diproses</h1>
    {% if images %}
    <button class="btn-danger" onclick="showConfirmDialog()">
        üóëÔ∏è Hapus Semua Riwayat
    </button>
    {% endif %}
</div>

{% if images %}
<table class="results-table">
    <thead>
        <tr>
            <th>No</th>
            <th>Nama Pengguna</th>
            <th>Filter</th>
            <th>Gambar Asli</th>
            <th>Gambar Hasil</th>
        </tr>
    </thead>
    <tbody>
        {% for img in images %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ img.username }}</td>
            <td>
                <span class="filter-badge">{{ img.filter }}</span>
            </td>
            <td>
                <img src="{{ url_for('uploaded_file', filename=img.original) }}" 
                     class="thumbnail" 
                     alt="Original"
                     onclick="showImage('{{ url_for('uploaded_file', filename=img.original) }}')">
            </td>
            <td>
                <img src="{{ url_for('processed_file', filename=img.processed) }}" 
                     class="thumbnail" 
                     alt="Processed"
                     onclick="showImage('{{ url_for('processed_file', filename=img.processed) }}')">
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="no-data">
    <p>Belum ada gambar yang diproses</p>
</div>
{% endif %}

<!-- Modal for image preview -->
<div id="imageModal" class="modal" onclick="closeModal()">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <img id="modalImage" class="modal-content" src="" alt="Preview">
</div>

<!-- Confirmation Dialog -->
<div id="confirmDialog" class="confirm-dialog">
    <div class="confirm-content">
        <h2>‚ö†Ô∏è Konfirmasi Hapus</h2>
        <p>Apakah Anda yakin ingin menghapus <strong>SEMUA</strong> riwayat pengolahan?</p>
        <p style="color: #d32f2f; margin-top: 10px;">
            <strong>Tindakan ini tidak dapat dibatalkan!</strong>
        </p>
        <div class="confirm-buttons">
            <button class="btn" onclick="hideConfirmDialog()">Batal</button>
            <form method="POST" action="{{ url_for('clear_history') }}" style="display: inline;">
                <button type="submit" class="btn-danger">Ya, Hapus Semua</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Image modal functions
    function showImage(src) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        modal.classList.add('show');
        modalImg.src = src;
    }

    function closeModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.remove('show');
    }

    // Confirmation dialog functions
    function showConfirmDialog() {
        const dialog = document.getElementById('confirmDialog');
        dialog.classList.add('show');
    }

    function hideConfirmDialog() {
        const dialog = document.getElementById('confirmDialog');
        dialog.classList.remove('show');
    }

    // Auto-hide flash messages after 5 seconds
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(function() {
                alert.remove();
            }, 500);
        });
    }, 5000);

    // Close modal when clicking outside image
    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Close confirm dialog when clicking outside
    document.getElementById('confirmDialog').addEventListener('click', function(e) {
        if (e.target === this) {
            hideConfirmDialog();
        }
    });
</script>
{% endblock %}